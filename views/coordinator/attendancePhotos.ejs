<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Attendance Photos</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body
    class="min-h-screen bg-gradient-to-br from-blue-50 via-white to-indigo-50"
  >
    <%- include("../partials/navbar", currUser, teacher) %>

    <div class="container mx-auto px-4 py-8 max-w-5xl">
      <div
        class="flex flex-col md:flex-row md:items-center md:justify-between mb-8 gap-3"
      >
        <div>
          <p class="text-sm text-gray-500">Teacher</p>
          <h1 class="text-3xl font-bold text-gray-800">
            <%= teacher.username %>
          </h1>
        </div>
      </div>

      <!-- Stats -->
      <div
        class="bg-white rounded-2xl shadow-md border border-gray-100 p-6 mb-8"
      >
        <p class="text-sm text-gray-500">Teacher Attendance</p>
        <h3 class="text-3xl font-bold text-green-600">
          <%= attendanceCount %> / <%= totalDays %>
        </h3>
        <p class="text-xs text-gray-500 mt-1">days present</p>
      </div>

      <!-- Gallery -->
      <div class="bg-white rounded-2xl shadow-md border border-gray-100 p-6">
        <div
          class="flex flex-col md:flex-row md:items-center md:justify-between mb-6 gap-3"
        >
          <h2 class="text-2xl font-bold text-gray-800">Attendance History</h2>
          <% if (attendancePhotos && attendancePhotos.length > 0) { %>
          <button
            onclick="downloadAllAttendancePhotos('<%= teacher._id %>', 'teacher')"
            class="px-4 py-2 rounded-lg bg-blue-500 text-white hover:bg-blue-600 transition-colors flex items-center justify-center gap-2"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
              />
            </svg>
            Download All
          </button>
          <% } %>
        </div>

        <% if (attendancePhotos && attendancePhotos.length > 0) { %>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <% attendancePhotos.forEach(photo => { %>
          <div
            class="border border-gray-200 rounded-xl overflow-hidden hover:shadow-lg transition-shadow duration-300"
          >
            <div
              class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white p-3"
            >
              <p class="font-semibold text-center">
                <%= new Date(photo.date).toLocaleDateString('en-IN', { weekday:
                'long', year: 'numeric', month: 'long', day: 'numeric' }) %>
              </p>
              <p class="text-xs text-center text-blue-100 mt-1">
                <%= new Date(photo.date).toLocaleTimeString('en-IN', { hour:
                '2-digit', minute: '2-digit' }) %>
              </p>
            </div>
            <div class="p-2">
              <img
                src="<%= photo.photo.path %>"
                alt="Attendance photo"
                class="w-full h-64 object-cover rounded-lg"
              />
            </div>
          </div>
          <% }) %>
        </div>
        <% } else { %>
        <div class="text-center py-12">
          <svg
            class="w-16 h-16 text-gray-300 mx-auto mb-4"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
            />
          </svg>
          <p class="text-gray-500 text-lg">No attendance photos yet</p>
        </div>
        <% } %>
      </div>
    </div>

    <script>
      async function downloadAllAttendancePhotos(userId, userType) {
        // Determine endpoint based on current page
        const currentPath = window.location.pathname;
        let endpoint;
        if (currentPath.includes("/coordinator/")) {
          endpoint = "/coordinator/download-all-attendance-photos";
        } else if (currentPath.includes("/head/")) {
          endpoint = "/head/download-all-attendance-photos";
        } else {
          alert("Unable to determine download endpoint");
          return;
        }

        // Try File System Access API to let user choose folder
        if ("showDirectoryPicker" in window) {
          try {
            const dirHandle = await window.showDirectoryPicker();
            const resp = await fetch(
              `/coordinator/attendance-photos/${userId}`
            );
            if (!resp.ok) throw new Error("Could not fetch photo list");
            const photos = await resp.json();

            // Save each photo with date appended to filename
            for (let i = 0; i < photos.length; i++) {
              const photo = photos[i];
              const photoDate = new Date(photo.date);
              const dateStr = photoDate
                .toLocaleDateString("en-CA")
                .replace(/\//g, "-");
              const timeStr = photoDate
                .toLocaleTimeString("en-GB", { hour12: false })
                .replace(/:/g, "-");
              const fileName = `${photo.username}_${dateStr}_${timeStr}_${
                i + 1
              }.jpg`;

              await saveImageToFolder(dirHandle, photo.photo.path, fileName);
            }
            alert("All photos saved to the selected folder.");
            return;
          } catch (err) {
            console.warn("Folder picker failed, falling back to ZIP:", err);
          }
        }

        // Fallback: server-side ZIP download
        try {
          const response = await fetch(endpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ userId, userType }),
          });
          if (!response.ok) throw new Error("Download failed");
          const blob = await response.blob();
          const blobUrl = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = blobUrl;
          a.download = `attendance_photos.zip`;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(blobUrl);
          document.body.removeChild(a);
        } catch (error) {
          console.error("Error downloading photos:", error);
          alert("Failed to download photos. Please try again.");
        }
      }

      async function saveImageToFolder(dirHandle, imageUrl, fileName) {
        const resp = await fetch("/coordinator/download-image", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ imageUrl, fileName }),
        });
        if (!resp.ok) throw new Error("Image fetch failed");
        const blob = await resp.blob();
        const fh = await dirHandle.getFileHandle(fileName, { create: true });
        const writable = await fh.createWritable();
        await writable.write(blob);
        await writable.close();
      }
    </script>
  </body>
</html>
