<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= __('lectureDetailsTitle') %></title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body
    class="min-h-screen bg-gradient-to-br from-blue-50 via-white to-indigo-50"
  >
    <%- include("../partials/navbar.ejs", currUser) %>

    <div class="container mx-auto px-4 py-8">
      <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">
          <%= __('lectureDetailsTitle') %>
        </h1>
      </div>

      <div class="flex flex-col gap-6 max-w-3xl mx-auto">
        <div
          class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden flex flex-col"
        >
          <!-- Header Section -->
          <div class="p-6 border-b border-gray-100">
            <div class="flex justify-between items-start gap-4 mb-4">
              <div>
                <h2 class="text-lg font-bold text-blue-600">
                  <%= lecture.date.toDateString() %>
                </h2>
                <p class="text-sm text-gray-600">
                  Time: <%= lecture.time ? lecture.time.toLocaleTimeString([], {
                  hour: '2-digit', minute: '2-digit' }) : 'N/A' %>
                </p>
                <p class="text-sm text-gray-600">üìç <%= lecture.address %></p>
              </div>
              <div class="flex gap-2">
                <div
                  class="px-3 py-2 rounded-lg bg-blue-50 border border-blue-100 text-center"
                >
                  <p class="text-xs text-gray-500">Students</p>
                  <p class="text-lg font-bold text-blue-600">
                    <%= lecture.attendanceCount || lecture.attendance || 0 %>
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- Activity Section -->
          <div class="px-6 py-4 border-b border-gray-100">
            <h3 class="text-sm font-semibold text-gray-800 mb-3">Activity</h3>
            <p
              class="text-sm text-gray-600 bg-gray-50 p-3 rounded-lg border border-gray-200 whitespace-pre-wrap"
            >
              <%= lecture.activity %>
            </p>
          </div>

          <!-- Student Attendance Section - Only Present Students -->
          <div class="px-6 py-4 border-b border-gray-100">
            <% const presentStudents = lecture.studentAttendance ?
            lecture.studentAttendance.filter(sa => sa.present) : []; %> <% if
            (presentStudents.length > 0) { %>
            <h3 class="text-sm font-semibold text-gray-800 mb-3">
              Students Present
            </h3>
            <div class="space-y-2">
              <% presentStudents.forEach((sa) => { %>
              <div
                class="flex items-center gap-3 p-2 rounded-lg bg-green-50 border border-green-200"
              >
                <div
                  class="w-6 h-6 rounded-full bg-green-500 flex items-center justify-center text-white text-xs flex-shrink-0"
                >
                  ‚úì
                </div>
                <span class="text-sm text-gray-800">
                  <%= sa.student ? sa.student.name : 'Student' %>
                </span>
              </div>
              <% }) %>
            </div>
            <% } %>
          </div>

          <!-- Images -->
          <div class="px-6 py-4 border-b border-gray-100">
            <h3 class="text-sm font-semibold text-gray-800 mb-3">Images</h3>
            <% if (lecture.images && lecture.images.length > 0) { %>
            <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
              <% lecture.images.forEach((image, idx) => { %>
              <div
                class="bg-gray-50 rounded-lg border border-gray-300 p-2 flex items-center justify-center relative group"
              >
                <img
                  src="<%= image.path %>"
                  alt="Image <%= idx + 1 %>"
                  class="max-w-full max-h-32 object-contain"
                />
                <button
                  type="button"
                  onclick="downloadImage('<%= image.path %>', '<%= lecture.address %>_<%= lecture.date.toISOString().split('T')[0] %>_image_<%= idx + 1 %>.jpg')"
                  class="absolute top-1 right-1 bg-blue-600 text-white p-1.5 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 hover:bg-blue-700 text-xs"
                  title="Download image"
                >
                  ‚¨áÔ∏è
                </button>
              </div>
              <% }) %>
            </div>
            <% } else { %>
            <p class="text-sm text-gray-500">No images available</p>
            <% } %>
          </div>

          <!-- Download All Images Button -->
          <div class="px-6 py-4 bg-gray-50">
            <button
              type="button"
              onclick="downloadAllImages('<%= lecture._id %>', '<%= lecture.address %>', '<%= lecture.date.toISOString().split('T')[0] %>')"
              class="w-full px-4 py-2 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700 transition"
            >
              üì• Download All Images
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Function to download a single image
      function downloadImage(imageUrl, fileName) {
        fetch("/coordinator/download-image", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ imageUrl, fileName }),
        })
          .then((response) => {
            if (!response.ok) throw new Error("Download failed");
            return response.blob();
          })
          .then((blob) => {
            const blobUrl = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = blobUrl;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(blobUrl);
            document.body.removeChild(a);
          })
          .catch((error) => {
            console.error("Error downloading image:", error);
            alert("Failed to download image. Please try again.");
          });
      }

      // Function to download all images
      async function downloadAllImages(reportId, address, date) {
        if ("showDirectoryPicker" in window) {
          try {
            const dirHandle = await window.showDirectoryPicker();
            const resp = await fetch(`/coordinator/report-images/${reportId}`);
            if (!resp.ok) throw new Error("Could not fetch image list");
            const { images } = await resp.json();

            for (let i = 0; i < (images || []).length; i++) {
              await saveImageToFolder(
                dirHandle,
                images[i],
                `${address}_${date}_image_${i + 1}.jpg`
              );
            }
            alert("All images saved to the selected folder.");
            return;
          } catch (err) {
            console.warn("Folder picker failed, falling back to ZIP:", err);
          }
        }
        // Fallback: ZIP download
        try {
          const response = await fetch(
            "/coordinator/download-all-report-images",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ reportId, address, date }),
            }
          );
          if (!response.ok) throw new Error("Download failed");
          const blob = await response.blob();
          const blobUrl = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = blobUrl;
          a.download = `${address}_${date}_images.zip`;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(blobUrl);
          document.body.removeChild(a);
        } catch (error) {
          console.error("Error downloading images:", error);
          alert("Failed to download images. Please try again.");
        }
      }

      async function saveImageToFolder(dirHandle, imageUrl, fileName) {
        const resp = await fetch("/coordinator/download-image", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ imageUrl, fileName }),
        });
        if (!resp.ok) throw new Error("Image fetch failed");
        const blob = await resp.blob();
        const fh = await dirHandle.getFileHandle(fileName, { create: true });
        const writable = await fh.createWritable();
        await writable.write(blob);
        await writable.close();
      }
    </script>
  </body>
</html>
